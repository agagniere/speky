kind: tests
category: functional
tests:
- id: TMCP003
  ref: [MCP002]
  short: Multiple requests in one session
  long: Verify the server handles multiple tool calls without restarting
  initial: The speky_mcp package is installed
  steps:
  - action: Start MCP server with sample specification files
    run: uv run python -m speky_mcp tests/samples/simple_requirements.yaml
  - action: Send initialize request
    sample_lang: json
    sample: |
      {
        "jsonrpc": "2.0",
        "method": "initialize",
        "params": {"protocolVersion": "2024-11-05", "capabilities": {}},
        "id": 1
      }
  - action: Send first tool call to list all IDs
    sample_lang: json
    sample: |
      {
        "jsonrpc": "2.0",
        "method": "tools/call",
        "params": {"name": "list_all_ids", "arguments": {}},
        "id": 2
      }
  - action: Verify response contains the IDs
    expected: Response includes ["RF01", "RF02"]
  - action: Send second tool call to get a specific requirement
    sample_lang: json
    sample: |
      {
        "jsonrpc": "2.0",
        "method": "tools/call",
        "params": {"name": "get_requirement", "arguments": {"id": "RF01"}},
        "id": 3
      }
  - action: Verify response contains requirement details
    expected: Response includes requirement RF01 data
  - action: Verify no file reload occurred between requests
    expected: Both requests responded quickly without reloading YAML files
